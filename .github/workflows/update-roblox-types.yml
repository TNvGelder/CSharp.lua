name: Update Roblox Types

on:
  schedule:
    - cron: '0 7 * * *'  # Daily at 7 AM UTC
  workflow_dispatch:  # Manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Run Roblox Type Generator
        run: dotnet run --project RobloxTypeGenerator -- --force

      - name: Build RobloxTypes
        run: dotnet build RobloxTypes

      - name: Run Validation Tests
        run: dotnet run --project RobloxValidation

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: 'chore: Update Roblox types from API'
          body: |
            Automated update of Roblox type definitions from [Roblox-Client-Tracker](https://github.com/MaximumADHD/Roblox-Client-Tracker).

            This PR was automatically generated by the Update Roblox Types workflow.

            **Changes:**
            - Updated `RobloxTypes/Generated/Classes.cs`
            - Updated `RobloxTypes/Generated/Enums.cs`
            - Updated `RobloxTypes.Plugin/Generated/PluginClasses.cs`
            - Updated `RobloxMetadata/Roblox.Generated.xml`
            - Updated `RobloxMetadata/Roblox.Plugin.Generated.xml`
          branch: update-roblox-types
          commit-message: 'chore: Update Roblox types from API'
          delete-branch: true
